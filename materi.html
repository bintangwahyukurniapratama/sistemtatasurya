<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simulasi Tata Surya (Tombol Batal Key)</title>
    
    <!-- Memuat Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            font-family: 'Inter', sans-serif;
            cursor: grab;
            touch-action: none;
            /* Latar belakang gradien NEBULA */
            background: radial-gradient(circle at center, #2a002a, #0d0d1a 50%, #000000 100%);
        }
        body.grabbing {
            cursor: grabbing;
        }
        canvas {
            display: block;
        }

        /* --- INFO BOX (POJOK KIRI ATAS) --- */
        #info-box-general {
            position: absolute;
            top: 10px;
            left: 10px;
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 15px;
            border-radius: 8px;
            max-width: 300px;
            z-index: 10;
            pointer-events: auto;
            transition: opacity 0.3s ease, transform 0.3s ease;
        }
        #info-box-general.minimized {
            opacity: 0;
            transform: translateX(-120%);
            pointer-events: none;
        }
        #info-box-general h1 {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 10px;
            color: #87ceeb;
        }
        #info-box-general p {
            font-size: 0.875rem;
            margin-bottom: 5px;
            line-height: 1.4;
        }
        #btn-hide-info {
            position: absolute;
            top: 5px;
            right: 10px;
            background: none;
            border: none;
            color: #aaa;
            font-size: 1.2rem;
            cursor: pointer;
        }
        #btn-hide-info:hover { color: white; }

        /* Tombol Show Info */
        #btn-show-info {
            position: absolute;
            top: 10px;
            left: 10px;
            width: 40px;
            height: 40px;
            background-color: rgba(0, 0, 0, 0.6);
            color: #87ceeb;
            border: 1px solid #87ceeb;
            border-radius: 50%;
            font-size: 1.2rem;
            font-weight: bold;
            cursor: pointer;
            z-index: 9;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: all 0.3s ease;
            opacity: 0;
            pointer-events: none;
        }
        #btn-show-info.visible { opacity: 1; pointer-events: auto; }
        #btn-show-info:hover { background-color: #87ceeb; color: black; transform: scale(1.1); }

        /* --- PANEL INFO OBJEK --- */
        #planet-info-panel {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(25, 25, 50, 0.95);
            color: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.5);
            width: 90%;
            max-width: 400px;
            z-index: 20;
            display: none;
            transition: all 0.3s ease-in-out;
            border: 1px solid rgba(100, 100, 255, 0.5);
            pointer-events: auto;
        }
        #planet-info-panel.visible { display: block; opacity: 1; }
        #planet-info-panel h2 { font-size: 1.8rem; font-weight: bold; color: #87ceeb; margin-bottom: 15px; text-align: center; }
        #planet-info-panel p { font-size: 1rem; margin-bottom: 8px; line-height: 1.5; }
        #planet-info-panel p strong { color: #aaddff; }
        #planet-info-panel .close-btn {
            position: absolute;
            top: 10px;
            right: 15px;
            font-size: 1.8rem;
            color: #aaa;
            cursor: pointer;
            background: none;
            border: none;
            padding: 5px;
            line-height: 1;
        }
        #planet-info-panel .close-btn:hover { color: #fff; }
        
        #btn-generate-quiz {
            display: block;
            width: 100%;
            margin-top: 15px;
            padding: 10px;
            background: linear-gradient(45deg, #6a11cb 0%, #2575fc 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s;
            text-align: center;
            box-shadow: 0 4px 15px rgba(106, 17, 203, 0.4);
        }
        #btn-generate-quiz:hover { transform: scale(1.02); box-shadow: 0 6px 20px rgba(106, 17, 203, 0.6); }

        .planet-label {
            color: white;
            background-color: rgba(0, 0, 0, 0.6);
            padding: 3px 8px;
            border-radius: 5px;
            font-size: 0.75rem;
            white-space: nowrap;
            pointer-events: auto; 
            cursor: pointer;      
            transform: translate(-50%, -50%);
            z-index: 5;
            transition: background-color 0.2s;
            user-select: none; 
        }
        .planet-label:hover { background-color: rgba(0, 100, 255, 0.8); z-index: 10; font-weight: bold; }

        /* --- AI CHATBOT --- */
        #ai-chat-toggle {
            position: absolute;
            bottom: 20px;
            right: 20px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 50px;
            padding: 12px 20px;
            font-size: 1rem;
            font-weight: 600;
            box-shadow: 0 4px 15px rgba(0, 123, 255, 0.5);
            cursor: pointer;
            z-index: 100;
            transition: all 0.3s ease;
            pointer-events: auto;
        }
        #ai-chat-toggle:hover { background-color: #0056b3; box-shadow: 0 6px 20px rgba(0, 123, 255, 0.7); }

        #ai-chat-container {
            position: absolute;
            bottom: 90px;
            right: 20px;
            width: 90%;
            max-width: 350px;
            height: 450px;
            background-color: rgba(10, 10, 30, 0.95);
            border: 1px solid rgba(100, 100, 255, 0.5);
            border-radius: 15px;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.5);
            z-index: 99;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            pointer-events: auto;
            opacity: 0;
            transform: translateY(20px);
            visibility: hidden;
            transition: all 0.3s ease-in-out;
        }
        #ai-chat-container.open { opacity: 1; transform: translateY(0); visibility: visible; }
        #ai-chat-header {
            padding: 15px;
            background-color: rgba(25, 25, 50, 1);
            color: #87ceeb;
            font-weight: bold;
            font-size: 1.1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        #ai-chat-close { background: none; border: none; color: #aaa; font-size: 1.5rem; cursor: pointer; line-height: 1; }
        #ai-chat-close:hover { color: white; }
        #ai-chat-messages { flex-grow: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 10px; }
        .ai-chat-message { padding: 10px 15px; border-radius: 18px; max-width: 80%; line-height: 1.4; }
        .user-message { background-color: #007bff; color: white; align-self: flex-end; border-bottom-right-radius: 5px; }
        .ai-message { background-color: #333; color: #eee; align-self: flex-start; border-bottom-left-radius: 5px; }
        #ai-chat-loading { text-align: center; padding: 10px; display: none; }
        #ai-chat-loading .spinner { width: 20px; height: 20px; border: 3px solid rgba(255, 255, 255, 0.3); border-radius: 50%; border-top-color: #fff; animation: spin 1s ease-in-out infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        #ai-chat-input-area { display: flex; padding: 10px; border-top: 1px solid rgba(100, 100, 255, 0.3); }
        #ai-chat-input { flex-grow: 1; border: none; background-color: #222; color: white; padding: 10px 15px; border-radius: 20px; margin-right: 10px; }
        #ai-chat-input:focus { outline: none; box-shadow: 0 0 0 2px #007bff; }
        #ai-chat-send { background-color: #007bff; border: none; color: white; padding: 0 15px; border-radius: 20px; font-weight: bold; cursor: pointer; }
        #ai-chat-send:hover { background-color: #0056b3; }

        /* MODAL INPUT API KEY */
        #api-key-modal {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        #api-key-box {
            position: relative; /* Penting untuk posisi tombol close */
            background: #1a1a2e;
            padding: 25px;
            border-radius: 15px;
            width: 90%;
            max-width: 400px;
            text-align: center;
            border: 1px solid #007bff;
            box-shadow: 0 0 20px rgba(0, 123, 255, 0.3);
        }
        #api-key-input {
            width: 100%;
            padding: 10px;
            margin: 15px 0;
            border-radius: 5px;
            border: 1px solid #333;
            background: #0f0f1a;
            color: white;
        }
        #save-api-key {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
        }
        /* Tombol Silang (Batal) di Modal */
        #close-api-modal-btn {
            position: absolute;
            top: 10px;
            right: 15px;
            background: none;
            border: none;
            color: #aaa;
            font-size: 1.5rem;
            cursor: pointer;
            line-height: 1;
        }
        #close-api-modal-btn:hover { color: #fff; }
    </style>

    <!-- Memuat Library Three.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/renderers/CSS2DRenderer.js"></script>
</head>
<body class="bg-gray-900">

    <!-- MODAL UNTUK INPUT API KEY -->
    <div id="api-key-modal">
        <div id="api-key-box">
            <!-- TOMBOL BATAL (SILANG) -->
            <button id="close-api-modal-btn" title="Batal">&times;</button>
            
            <h2 class="text-xl font-bold text-blue-400 mb-2">Masukkan Gemini API Key</h2>
            <p class="text-gray-300 text-sm mb-4">Agar fitur AI berfungsi di komputer Anda, silakan tempel API Key Anda di sini.</p>
            <input type="text" id="api-key-input" placeholder="Tempel API Key di sini (AIzaSy...)" />
            <button id="save-api-key">Simpan & Mulai</button>
            <p class="text-xs text-gray-500 mt-3">Key akan disimpan di browser Anda. Klik silang jika ingin melihat simulasi saja.</p>
        </div>
    </div>

    <!-- Kontainer untuk simulasi 3D -->
    <div id="simulation-container"></div>

    <!-- TOMBOL SHOW INFO (MUNCUL SAAT BOX DI-HIDE) -->
    <button id="btn-show-info" title="Tampilkan Info">‚ÑπÔ∏è</button>

    <!-- Panel Info Bantuan -->
    <div id="info-box-general">
        <button id="btn-hide-info" title="Sembunyikan">‚úñ</button>
        <h1>Simulasi Tata Surya</h1>
        <p><strong>Klik Kiri + Geser:</strong> Memutar (Rotate).</p>
        <p><strong>Klik Kanan + Geser:</strong> Menggeser (Pan).</p>
        <p><strong>Scroll:</strong> Zoom.</p>
        <p class="mt-2">Klik objek atau teks namanya untuk info!</p>
    </div>

    <!-- Panel Info Objek (Tersembunyi) -->
    <div id="planet-info-panel" class="hidden">
        <button class="close-btn" id="close-panel-btn">‚úñ</button>
        <h2 id="planet-name-display"></h2>
        <p><strong>Jarak:</strong> <span id="planet-distance-display"></span></p>
        <p><strong>Kategori:</strong> <span id="planet-order-display"></span></p>
        <p><strong>Ukuran Relatif:</strong> <span id="planet-size-display"></span></p>
        <p><strong>Kecepatan Orbit:</strong> <span id="planet-speed-display"></span></p>
        <p><strong>Ciri Khas:</strong> <span id="planet-feature-display"></span></p>
        <!-- FITUR GEMINI AI BARU -->
        <button id="btn-generate-quiz" onclick="triggerAiQuiz()">‚ú® Fakta & Kuis AI</button>
    </div>

    <!-- Tombol dan Jendela AI Chatbot -->
    <button id="ai-chat-toggle">Tanya AI ü§ñ</button>
    <div id="ai-chat-container">
        <div id="ai-chat-header">
            <span>Asisten AI AstroBot</span>
            <button id="ai-chat-close">&times;</button>
        </div>
        <div id="ai-chat-messages">
            <div class="ai-chat-message ai-message">
                Halo! Saya AstroBot. Silakan tanya apa saja tentang antariksa!
            </div>
        </div>
        <div id="ai-chat-loading">
            <div class="spinner"></div>
        </div>
        <div id="ai-chat-input-area">
            <input type="text" id="ai-chat-input" placeholder="Ketik pertanyaanmu...">
            <button id="ai-chat-send">Kirim</button>
        </div>
    </div>

    <script>
        // --- LOGIKA API KEY OTOMATIS ---
        let userApiKey = localStorage.getItem("gemini_api_key") || ""; 

        function checkApiKey() {
            if (!userApiKey) {
                document.getElementById('api-key-modal').style.display = 'flex';
            }
        }

        document.getElementById('save-api-key').addEventListener('click', () => {
            const inputKey = document.getElementById('api-key-input').value.trim();
            if (inputKey) {
                userApiKey = inputKey;
                localStorage.setItem("gemini_api_key", inputKey);
                document.getElementById('api-key-modal').style.display = 'none';
                alert("API Key tersimpan! Silakan gunakan fitur AI.");
            } else {
                alert("Mohon masukkan API Key yang valid.");
            }
        });

        // LOGIKA TOMBOL BATAL (SILANG) DI MODAL
        document.getElementById('close-api-modal-btn').addEventListener('click', () => {
            document.getElementById('api-key-modal').style.display = 'none';
        });

        // --- LOGIKA HIDE/SHOW INFO BOX ---
        const infoBox = document.getElementById('info-box-general');
        const btnHideInfo = document.getElementById('btn-hide-info');
        const btnShowInfo = document.getElementById('btn-show-info');

        btnHideInfo.addEventListener('click', () => {
            infoBox.classList.add('minimized');
            btnShowInfo.classList.add('visible');
        });

        btnShowInfo.addEventListener('click', () => {
            infoBox.classList.remove('minimized');
            btnShowInfo.classList.remove('visible');
        });

        // --- THREE.JS SETUP ---
        let scene, camera, renderer, controls, labelRenderer;
        const celestialBodies = []; 
        const raycaster = new THREE.Raycaster();
        const mouse = new THREE.Vector2();

        let pointerDownTime = 0;
        let pointerDownPosition = new THREE.Vector2();
        let currentSelectedPlanet = "";
        let starfield1, starfield2, asteroidBelt;

        // --- DATA BARU DENGAN SATUAN JELAS UNTUK SD ---
        const celestialBodyData = [
            { 
                name: 'Matahari', 
                type: 'star', 
                size: 15, 
                color: 0xffdd00, 
                distance: 0, 
                speed: 0, 
                inclination: 0, 
                order: 0, 
                relativeSize: 'Sangat Besar', 
                realDistanceStr: '0 km (Pusat Tata Surya)', 
                realSpeedStr: '0 km/detik (Pusat Rotasi)', 
                features: 'Bintang pusat tata surya. Sangat panas dan memberikan cahaya bagi semua planet.' 
            },
            { 
                name: 'Merkurius', 
                type: 'planet', 
                size: 3.2, 
                color: 0x888888, 
                distance: 30, 
                speed: 4.15, 
                inclination: 0.0, 
                order: 1, 
                relativeSize: 'Kecil', 
                realDistanceStr: '58 Juta km', 
                realSpeedStr: '47 km/detik', 
                features: 'Planet terkecil dan paling dekat dengan Matahari.' 
            },
            { 
                name: 'Venus', 
                type: 'planet', 
                size: 5.8, 
                color: 0xe5c100, 
                distance: 50, 
                speed: 1.62, 
                inclination: 0.0, 
                order: 2, 
                relativeSize: 'Sedang', 
                realDistanceStr: '108 Juta km', 
                realSpeedStr: '35 km/detik', 
                features: 'Planet terpanas, lebih panas dari Merkurius karena atmosfer tebal.' 
            },
            { 
                name: 'Bumi', 
                type: 'planet', 
                size: 6, 
                color: 0x0077ff, 
                distance: 75, 
                speed: 1.0, 
                inclination: 0.0, 
                order: 3, 
                relativeSize: 'Sedang', 
                realDistanceStr: '150 Juta km', 
                realSpeedStr: '30 km/detik', 
                features: 'Tempat tinggal kita! Satu-satunya planet yang diketahui ada kehidupan.' 
            },
            { 
                name: 'Mars', 
                type: 'planet', 
                size: 4, 
                color: 0xff5500, 
                distance: 100, 
                speed: 0.53, 
                inclination: 0.0, 
                order: 4, 
                relativeSize: 'Kecil', 
                realDistanceStr: '228 Juta km', 
                realSpeedStr: '24 km/detik', 
                features: 'Planet Merah. Banyak gunung berapi mati dan lembah kering.' 
            },
            { 
                name: 'Jupiter', 
                type: 'planet', 
                size: 12, 
                color: 0xff9900, 
                distance: 150, 
                speed: 0.084, 
                inclination: 0.0, 
                order: 5, 
                relativeSize: 'Sangat Besar', 
                realDistanceStr: '778 Juta km', 
                realSpeedStr: '13 km/detik', 
                features: 'Planet terbesar. Bola gas raksasa dengan bintik merah besar.' 
            },
            { 
                name: 'Saturnus', 
                type: 'planet', 
                size: 10, 
                color: 0xf0d8a0, 
                distance: 200, 
                speed: 0.034, 
                inclination: 0.0, 
                order: 6, 
                relativeSize: 'Sangat Besar', 
                realDistanceStr: '1.4 Miliar km', 
                realSpeedStr: '9.7 km/detik', 
                features: 'Terkenal dengan cincinnya yang indah dari es dan batu.' 
            },
            { 
                name: 'Uranus', 
                type: 'planet', 
                size: 7, 
                color: 0x99ccff, 
                distance: 250, 
                speed: 0.012, 
                inclination: 0.0, 
                order: 7, 
                relativeSize: 'Besar', 
                realDistanceStr: '2.9 Miliar km', 
                realSpeedStr: '6.8 km/detik', 
                features: 'Planet es yang menggelinding miring saat mengelilingi Matahari.' 
            },
            { 
                name: 'Neptunus', 
                type: 'planet', 
                size: 6.8, 
                color: 0x0055dd, 
                distance: 300, 
                speed: 0.006, 
                inclination: 0.0, 
                order: 8, 
                relativeSize: 'Besar', 
                realDistanceStr: '4.5 Miliar km', 
                realSpeedStr: '5.4 km/detik', 
                features: 'Planet terjauh. Sangat dingin dan memiliki angin tercepat.' 
            },
            { 
                name: 'Bulan', 
                type: 'moon', 
                parent: 'Bumi', 
                size: 3.0, 
                color: 0xaaaaaa, 
                distance: 12, 
                speed: 2.0, 
                inclination: 0.05, 
                order: 0, 
                relativeSize: 'Kecil', 
                realDistanceStr: '384 Ribu km (dari Bumi)', 
                realSpeedStr: '1 km/detik', 
                features: 'Satelit alami Bumi. Menyebabkan pasang surut air laut.' 
            },
            { 
                name: 'Satelit Buatan', 
                type: 'satellite', 
                parent: 'Bumi', 
                size: 2.5, 
                color: 0xeeeeff, 
                distance: 18, 
                speed: 2.5, 
                inclination: 0.1, 
                order: 0, 
                relativeSize: 'Mikro', 
                realDistanceStr: '~36.000 km (dari Bumi)', 
                realSpeedStr: '3 km/detik', 
                features: 'Mesin buatan manusia untuk komunikasi (HP, Internet) dan cuaca.' 
            },
            { 
                name: 'Pluto', 
                type: 'dwarfPlanet', 
                size: 3.8, 
                color: 0xd2a68c, 
                distance: 350, 
                speed: 0.004, 
                inclination: 0.2, 
                order: 9, 
                relativeSize: 'Sangat Kecil', 
                realDistanceStr: '5.9 Miliar km', 
                realSpeedStr: '4.7 km/detik', 
                features: 'Planet Katai. Dulu dianggap planet ke-9, tapi ternyata terlalu kecil.' 
            },
            { 
                name: 'Komet', 
                type: 'comet', 
                size: 3.0, 
                color: 0xaaccff, 
                distance: 400, 
                speed: 0.003, 
                inclination: 0.5, 
                order: 0, 
                relativeSize: 'Sangat Kecil', 
                realDistanceStr: 'Sangat Jauh & Berubah-ubah', 
                realSpeedStr: 'Cepat saat dekat Matahari', 
                features: 'Bola salju kotor dari luar angkasa. Punya ekor saat dekat Matahari.' 
            },
            { 
                name: 'Meteoroid', 
                type: 'meteoroid', 
                size: 2.5, 
                color: 0x968c83, 
                distance: 450, 
                speed: 0.002, 
                inclination: 0.4, 
                order: 0, 
                relativeSize: 'Kecil', 
                realDistanceStr: 'Bervariasi', 
                realSpeedStr: 'Bervariasi', 
                features: 'Batu angkasa melayang. Jika masuk atmosfer = Meteor (Bintang Jatuh). Jika sampai tanah = Meteorit.' 
            }
        ];

        function init() {
            scene = new THREE.Scene();
            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 5000);
            camera.position.set(0, 100, 250);

            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.domElement.style.pointerEvents = 'auto';
            document.getElementById('simulation-container').appendChild(renderer.domElement);

            labelRenderer = new THREE.CSS2DRenderer();
            labelRenderer.setSize(window.innerWidth, window.innerHeight);
            labelRenderer.domElement.style.position = 'absolute';
            labelRenderer.domElement.style.top = '0px';
            labelRenderer.domElement.style.pointerEvents = 'none'; 
            document.getElementById('simulation-container').appendChild(labelRenderer.domElement);

            controls = new THREE.OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            controls.dampingFactor = 0.07;
            controls.maxDistance = 1500;
            controls.minDistance = 5;
            controls.enablePan = true;
            controls.mouseButtons = { LEFT: THREE.MOUSE.ROTATE, MIDDLE: THREE.MOUSE.DOLLY, RIGHT: THREE.MOUSE.PAN };
            controls.touches = { ONE: THREE.TOUCH.ROTATE, TWO: THREE.TOUCH.DOLLY_PAN };

            const ambientLight = new THREE.AmbientLight(0x333333);
            scene.add(ambientLight);

            const sunGeometry = new THREE.SphereGeometry(15, 32, 32);
            const sunMaterial = new THREE.MeshBasicMaterial({ color: 0xffdd00 });
            const sun = new THREE.Mesh(sunGeometry, sunMaterial);
            scene.add(sun);
            const pointLight = new THREE.PointLight(0xffffff, 2, 1000);
            sun.add(pointLight);

            celestialBodyData.forEach(data => { createBody(data); });
            createAsteroidBelt();
            starfield1 = createStarfield(10000, 0.7, 2000, 0xddddff); 
            starfield2 = createStarfield(5000, 0.5, 3000, 0xaaaaee); 
            scene.add(starfield1); scene.add(starfield2);

            renderer.domElement.addEventListener('pointerdown', onPointerDownCanvas, false);
            renderer.domElement.addEventListener('pointerup', onPointerUpCanvas, false);
            document.getElementById('close-panel-btn').addEventListener('click', closePlanetInfo);
            document.getElementById('planet-info-panel').addEventListener('pointerdown', (e) => e.stopPropagation());
            window.addEventListener('pointerdown', onWindowPointerDown, false);
            window.addEventListener('resize', onWindowResize, false);

            animate();
        }

        function createBody(data) {
            // Khusus Matahari, tidak pakai pivot rotasi orbit
            if (data.type === 'star') {
                const sunGeometry = new THREE.SphereGeometry(data.size, 32, 32);
                const sunMaterial = new THREE.MeshBasicMaterial({ color: data.color }); // Bersinar
                const sun = new THREE.Mesh(sunGeometry, sunMaterial);
                sun.userData = data; // Agar bisa diklik
                
                // Label Nama Matahari
                const labelDiv = document.createElement('div'); 
                labelDiv.className = 'planet-label'; 
                labelDiv.textContent = data.name;
                
                // PERBAIKAN: Event listener untuk klik pada label
                labelDiv.addEventListener('pointerdown', (e) => {
                    e.stopPropagation(); // Mencegah klik tembus ke canvas
                    displayObjectInfo(data); // Tampilkan info
                });

                const labelObj = new THREE.CSS2DObject(labelDiv); 
                labelObj.position.set(0, -(data.size + 5), 0);
                sun.add(labelObj);
                
                scene.add(sun);
                celestialBodies.push({ name: data.name, pivot: null, planet: sun, speed: 0, distance: 0 });
                return;
            }

            const pivot = new THREE.Object3D();
            pivot.initialRotation = Math.random() * Math.PI * 2; 
            pivot.rotation.y = pivot.initialRotation;
            pivot.rotation.x = data.inclination || 0;

            let bodyGeometry, bodyMaterial, body;
            
            if (data.type === 'satellite') {
                bodyGeometry = new THREE.BoxGeometry(data.size * 2, data.size * 2, data.size * 2);
                bodyMaterial = new THREE.MeshStandardMaterial({ color: data.color });
                const panelGeom = new THREE.BoxGeometry(data.size * 5, data.size * 0.5, data.size * 0.5);
                const panelMat = new THREE.MeshBasicMaterial({ color: 0x0000ff });
                const panel1 = new THREE.Mesh(panelGeom, panelMat); panel1.position.x = data.size * 3;
                const panel2 = panel1.clone(); panel2.position.x = -data.size * 3;
                body = new THREE.Group(); body.add(new THREE.Mesh(bodyGeometry, bodyMaterial)); body.add(panel1); body.add(panel2);
                body.position.x = data.distance; body.userData = data; pivot.add(body);
            } else if (data.type === 'comet') {
                bodyGeometry = new THREE.SphereGeometry(data.size, 32, 32);
                bodyMaterial = new THREE.MeshStandardMaterial({ color: data.color });
                body = new THREE.Mesh(bodyGeometry, bodyMaterial);
                const tailGeom = new THREE.ConeGeometry(data.size * 0.5, data.size * 10, 8);
                const tailMat = new THREE.MeshBasicMaterial({ color: 0xaaccff, transparent: true, opacity: 0.3, blending: THREE.AdditiveBlending });
                const tail = new THREE.Mesh(tailGeom, tailMat); tail.position.z = data.size * 5; tail.rotation.x = Math.PI / 2; 
                body.add(tail); body.position.x = data.distance; body.userData = data; pivot.add(body);
            } else {
                bodyGeometry = new THREE.SphereGeometry(data.size, 32, 32);
                bodyMaterial = new THREE.MeshStandardMaterial({ color: data.color });
                body = new THREE.Mesh(bodyGeometry, bodyMaterial);
                body.position.x = data.distance; body.userData = data; pivot.add(body);
            }

            if ((data.type === 'moon' || data.type === 'satellite') && data.parent) {
                const parentBody = celestialBodies.find(p => p.name === data.parent);
                if (parentBody) parentBody.planet.add(pivot); else scene.add(pivot);
            } else { scene.add(pivot); }

            if (data.type !== 'moon' && data.type !== 'satellite') {
                const orbitGeometry = new THREE.BufferGeometry();
                const orbitVertices = []; const segments = 100;
                for (let i = 0; i <= segments; i++) {
                    const theta = (i / segments) * Math.PI * 2;
                    orbitVertices.push(Math.cos(theta) * data.distance, 0, Math.sin(theta) * data.distance);
                }
                orbitGeometry.setAttribute('position', new THREE.Float32BufferAttribute(orbitVertices, 3));
                const orbitMaterial = new THREE.LineBasicMaterial({ color: 0x999999, opacity: 0.7, transparent: true });
                const orbit = new THREE.LineLoop(orbitGeometry, orbitMaterial);
                orbit.rotation.x = data.inclination || 0; scene.add(orbit);
            }

            if (data.name === 'Saturnus') {
                const ringGeometry = new THREE.RingGeometry(data.size * 1.2, data.size * 1.8, 64);
                const ringMaterial = new THREE.MeshBasicMaterial({ color: 0xaaaaaa, side: THREE.DoubleSide, transparent: true, opacity: 0.7 });
                const ring = new THREE.Mesh(ringGeometry, ringMaterial);
                ring.rotation.x = Math.PI / 2; ring.rotation.y = Math.PI / 8; body.add(ring);
            }

            const planetDiv = document.createElement('div'); planetDiv.className = 'planet-label'; planetDiv.textContent = data.name;

            // PERBAIKAN: Event listener untuk klik pada label
            planetDiv.addEventListener('pointerdown', (e) => {
                e.stopPropagation(); // Mencegah klik tembus ke canvas
                displayObjectInfo(data); // Tampilkan info
            });

            const planetLabel = new THREE.CSS2DObject(planetDiv); planetLabel.position.set(0, -(data.size + 5), 0); body.add(planetLabel);

            celestialBodies.push({ name: data.name, pivot: pivot, planet: body, speed: data.speed, distance: data.distance });
        }

        function createAsteroidBelt() {
            const particles = 20000; const geometry = new THREE.BufferGeometry(); const positions = [];
            const radius = 125; const width = 25;
            for (let i = 0; i < particles; i++) {
                const angle = Math.random() * Math.PI * 2;
                const r = radius + (Math.random() - 0.5) * width;
                const y = (Math.random() - 0.5) * 3;
                positions.push(Math.cos(angle) * r, y, Math.sin(angle) * r);
            }
            geometry.setAttribute('position', new THREE.Float32BufferAttribute(positions, 3));
            const material = new THREE.PointsMaterial({ color: 0x665544, size: 0.1, transparent: true, opacity: 0.7 });
            asteroidBelt = new THREE.Points(geometry, material); scene.add(asteroidBelt);
        }

        function createStarfield(numStars, size, spread, color) {
            const starGeometry = new THREE.BufferGeometry(); const starVertices = [];
            for (let i = 0; i < numStars; i++) {
                const x = (Math.random() - 0.5) * spread * 2; const y = (Math.random() - 0.5) * spread * 2; const z = (Math.random() - 0.5) * spread * 2;
                starVertices.push(x, y, z);
            }
            starGeometry.setAttribute('position', new THREE.Float32BufferAttribute(starVertices, 3));
            const starMaterial = new THREE.PointsMaterial({ color: color, size: size, transparent: true, opacity: 0.8 });
            return new THREE.Points(starGeometry, starMaterial);
        }

        function onPointerDownCanvas(event) {
            if (document.getElementById('ai-chat-container').contains(event.target)) return;
            pointerDownTime = Date.now(); pointerDownPosition.set(event.clientX, event.clientY);
        }

        function onPointerUpCanvas(event) {
            if (document.getElementById('ai-chat-container').contains(event.target)) return;
            const duration = Date.now() - pointerDownTime;
            const distance = pointerDownPosition.distanceTo(new THREE.Vector2(event.clientX, event.clientY));
            if (duration < 300 && distance < 10) {
                mouse.x = (event.clientX / window.innerWidth) * 2 - 1;
                mouse.y = -(event.clientY / window.innerHeight) * 2 + 1;
                raycaster.setFromCamera(mouse, camera);
                const intersects = raycaster.intersectObjects(celestialBodies.map(p => p.planet));
                if (intersects.length > 0) {
                    const obj = intersects[0].object.userData;
                    displayObjectInfo(obj);
                } else {
                    closePlanetInfo();
                }
            }
        }

        function onWindowPointerDown(event) {
            if (document.getElementById('info-box-general').contains(event.target) || 
                document.getElementById('planet-info-panel').contains(event.target) ||
                document.getElementById('ai-chat-toggle').contains(event.target) ||
                document.getElementById('ai-chat-container').contains(event.target) ||
                document.getElementById('api-key-modal').contains(event.target) ||
                document.getElementById('btn-show-info').contains(event.target)) { // Tambah pengecekan tombol show
                return;
            }
            if (event.target === renderer.domElement) return;
            closePlanetInfo();
        }

        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
            labelRenderer.setSize(window.innerWidth, window.innerHeight);
        }

        function animate() {
            requestAnimationFrame(animate);
            const time = Date.now() * 0.0002;
            celestialBodies.forEach(p => {
                if (p.pivot) { // Planet/Object with orbit
                    p.pivot.rotation.y = p.pivot.initialRotation + (time * p.speed);
                    if (p.planet.rotation) p.planet.rotation.y += 0.005;
                }
                // Label visibility logic
                const labelObj = p.planet.children.find(child => child.isCSS2DObject);
                if (labelObj && labelObj.element) {
                    const vec = new THREE.Vector3(); p.planet.getWorldPosition(vec);
                    const dist = camera.position.distanceTo(vec);
                    labelObj.element.style.display = (dist > 600 || dist < 10) ? 'none' : 'block';
                }
            });
            starfield1.rotation.y = camera.rotation.y * 0.05;
            starfield2.rotation.y = camera.rotation.y * 0.02;
            if (asteroidBelt) asteroidBelt.rotation.y += 0.0001;
            controls.update();
            renderer.render(scene, camera);
            labelRenderer.render(scene, camera);
        }

        function displayObjectInfo(data) {
            const panel = document.getElementById('planet-info-panel');
            currentSelectedPlanet = data.name;
            document.getElementById('planet-name-display').textContent = data.name;
            document.getElementById('planet-distance-display').textContent = data.realDistanceStr;
            document.getElementById('planet-speed-display').textContent = data.realSpeedStr;
            
            let typeText = data.type.toUpperCase();
            if(data.type === 'star') typeText = "BINTANG";
            if(data.type === 'planet') typeText = "PLANET";
            if(data.type === 'moon') typeText = "SATELIT ALAMI";
            
            document.getElementById('planet-order-display').textContent = typeText;
            document.getElementById('planet-size-display').textContent = data.relativeSize;
            document.getElementById('planet-feature-display').textContent = data.features;
            document.getElementById('planet-info-panel').classList.add('visible');
            document.getElementById('planet-info-panel').classList.remove('hidden');
        }

        function closePlanetInfo() {
            document.getElementById('planet-info-panel').classList.remove('visible');
            document.getElementById('planet-info-panel').classList.add('hidden');
        }

        // --- AI FUNCTIONS ---
        function triggerAiQuiz() {
            if(!userApiKey) { checkApiKey(); return; }
            if (!currentSelectedPlanet) return;
            document.getElementById('ai-chat-container').classList.add('open');
            const prompt = `Berikan fakta unik dan kuis tentang ${currentSelectedPlanet} untuk anak SD.`;
            displayMessage(prompt, 'user');
            getAiResponse(prompt);
        }

        document.getElementById('ai-chat-send').addEventListener('click', () => {
            if(!userApiKey) { checkApiKey(); return; }
            const text = document.getElementById('ai-chat-input').value;
            if(text) {
                displayMessage(text, 'user');
                getAiResponse(text);
                document.getElementById('ai-chat-input').value = '';
            }
        });

        document.getElementById('ai-chat-toggle').addEventListener('click', () => {
            if(!userApiKey) { checkApiKey(); return; }
            document.getElementById('ai-chat-container').classList.toggle('open');
        });

        document.getElementById('ai-chat-close').addEventListener('click', () => {
            document.getElementById('ai-chat-container').classList.remove('open');
        });

        function displayMessage(msg, sender) {
            const div = document.createElement('div');
            div.className = `ai-chat-message ${sender === 'user' ? 'user-message' : 'ai-message'}`;
            div.innerHTML = msg.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            document.getElementById('ai-chat-messages').appendChild(div);
            document.getElementById('ai-chat-messages').scrollTop = document.getElementById('ai-chat-messages').scrollHeight;
        }

        async function getAiResponse(query) {
            document.getElementById('ai-chat-loading').style.display = 'block';
            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${userApiKey}`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ contents: [{ parts: [{ text: query }] }] })
                });
                const data = await response.json();
                const reply = data.candidates?.[0]?.content?.parts?.[0]?.text || "Maaf, terjadi kesalahan.";
                displayMessage(reply, 'ai');
            } catch (e) {
                displayMessage("Gagal menghubungi AI. Cek koneksi atau API Key.", 'ai');
            }
            document.getElementById('ai-chat-loading').style.display = 'none';
        }

        init();
    </script>
</body>
</html>